#!/bin/sh
# Pre-push hook for Ultimo
#
# Skip this hook with: git push --no-verify

# Check if pushing to main branch
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
remote_branch=$(git rev-parse --abbrev-ref --symbolic-full-name @{push} 2>/dev/null | sed 's/.*\///')

if [ "$remote_branch" = "main" ] || [ "$current_branch" = "main" ]; then
    echo "üö´ Direct pushes to main branch are not allowed!"
    echo ""
    echo "üìã Please follow the workflow:"
    echo "  1. Create a branch: git checkout -b feature/issue-123-description"
    echo "  2. Make your changes and commit"
    echo "  3. Push your branch: git push origin feature/issue-123-description"
    echo "  4. Create a Pull Request on GitHub"
    echo ""
    echo "üí° To push anyway (emergency only): git push --no-verify"
    exit 1
fi

echo "üöÄ Running pre-push checks..."
echo "   üí° Skip with: git push --no-verify"
echo ""

# Run tests
echo "  üß™ Running tests..."
if ! cargo test --lib --features database --quiet; then
    echo ""
    echo "‚ùå Tests failed!"
    echo "   Fix the failing tests or skip with: git push --no-verify"
    exit 1
fi

# Run clippy
echo "  üìé Running clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings 2>&1 | grep -q "Finished"; then
    echo "‚ö†Ô∏è  Clippy warnings found, but continuing..."
fi

# Check coverage threshold
echo "  üìä Checking coverage..."
if ! cargo coverage 2>&1 | grep -q "Coverage meets minimum threshold"; then
    echo ""
    echo "‚ùå Coverage below minimum threshold (60%)!"
    echo "   Add more tests or skip with: git push --no-verify"
    exit 1
fi

echo "‚úÖ All pre-push checks passed!"
exit 0
